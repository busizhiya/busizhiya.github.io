---
title: x86学习笔记
date: 2021-08-05 23:25:30
tags: OS
---
# x86实模式&保护模式

## 我的github项目~https://github.com/busizhiya/x86-Assembly-learning
## 001 简述

### 学习目的:

1.了解解计算机的底层原理,如何与硬件沟通,不只是汇编原理
		2.学习计算机工作远离,8086实模式,保护模式、特权级、分页、多任务、任务切换
		3.打下好基础,提升对计算机系统、操作系统的认识

## 002 计算机的概述

### 	003加法器

### 	004用电表示数

​		开关/电平高低

### 	005寄存器/锁存器

​		锁存,保存数据:触发器

### 	006带寄存器的加法机

准备输入A,按下预置,将数字A存入寄存器

准备输入B,点击相加,将寄存器中内容与B相加

...

无论何时,加法器的输出为寄存器

### 	007四则运算电路

预置,锁存

加、减、乘、除

将输入与寄存器中内容进行运算,存回寄存器

将运算结果存回寄存器以达到连续运算的效果

### 	008机器指令

在进行复杂运算时,会产生多个中间结果无法直接参与运算,因此设置多个寄存器

在可以选择的情况下,机器指令就诞生了

发送不同的指令执行不同的操作

### 	009内存

#### 用地址(编号)区分内存

n根地址总线		可寻址范围0~2^n-1  		共2^n个地址

8 Bits=1Byte

每个内存单元长度为1Byte

进位2^10=1024

B->KB->MB->GB->TB->PB...

#### 数据总线传输数据

#### 控制总线

发送读、写操作

### 010自动计算

指令指针寄存器

指令计数器

操作码-操作数

立即数->操作数包含在指令中

停机指令

## 011处理器的历史

控制部分,	IO部分,	运算、存储部分

n位的处理器有n位的寄存器和ALU

#### 指令集ISA:

1.算术、逻辑运算

2.数据传送指令

3.处理器状态指令

## 012 汇编语言的诞生

抽象化,更简单,容易书写

需要将汇编语言翻译为机器指令

### 	013认识8086

​	AX、BX、CX、DX、SI、DI、BP、SP

​		X(16)->H(8) L(8)

AX由AH和AL组成

最高位15 14 13...1 0最低位

每一个16进制代表四个二进制

1Word=2Bytes

### 	014 8086的内存访问和字节序

​	高位在高地址,低位在低地址		-> 低端字节序

​	16位寄存器占用两个内存单元

​	数据总线为16位,当传输8位时,高8位不用

### 	015 程序的分段

占据连续的区段,称为代码/数据段

### 	016程序重定位

IPR=当前指令地址+当前指令长度

如果在编写程序时使用固定地址(绝对地址/物理地址),当程序加载地址不同时,取得的数据就不一样,无法重定位.

所以使用相对定位的方式,相对于数据段的地址进行偏移

### 	017 段地址&偏移地址

每次加载程序时,程序会定位段地址,我们则使用相对的偏移地址,这样就不需要改动程序的地址了~

程序开始时,将起始代码段地址传送到IPR

将数据段地址传送到DSR

DSR+偏移地址	的内存

### 	018 8086在访问内存的困境

​	有20根地址线(1M),但只有16位的寄存器

​	CS Code Segment,代码段寄存器

​	DS Data Segment,数据段寄存器

### 	019 8086段地址选择策略

​	只有以0结尾的地址才能成为段地址,并且要向右移一位

​	‘30CE0’  -> DS  -> ’30CE‘

​	这样就保证了20位的访问范围

### 	020 8086的内存访问过程

​	将CS、DS赋值为起始地址(16进制)右移一位(除以16)

​	在访问内存时将段地址向左移动一位(16进制),再加上段偏移地址得到实际的地址

### 	021 逻辑地址和分段地址的灵活性

​		段地址:偏移地址 e.g 65C7:0003	逻辑地址

​		22567

​		2256:0007

​		2255:0017

​		...

​		1257:FFF7

​		一个段的长度最大是2^16,64K

### 	022 略

### 	023 创建汇编语言源程序

本人使用MacOs环境,

使用nasm作为编译器

使用Sublime Text作为编辑器,使用插件

​	插件:

​				[汇编高亮](https://blog.csdn.net/liuchuo/article/details/51987174)

​				16进制查看器[HexViewer](https://facelessuser.github.io/HexViewer/)

1.编写代码2.编译.obj文件3.链接形成二进制文件4.执行

;注释

### 	024~029 环境配置,略

### 	030 8086加电、复位状态

![截屏2021-08-05 下午12.26.04](https://tva1.sinaimg.cn/large/008i3skNly1gt5ssfcs8aj319g0u0ade.jpg)

### 	031 8086地址空间分配![截屏2021-08-05 下午12.36.34](https://tva1.sinaimg.cn/large/008i3skNly1gt5t3d1k23j319g0u0dis.jpg)

由于复位后cs为FFFF,所以开机后首先执行的就是FFFF:0000,即BIOS所在内存处

### 	032 跳转指令

开机后读取的地址为FFFF0,离末端FFFFF只有16字节,所以这里存放的都是跳转指令

除非发生跳转,处理器执行顺序都是由低地址向高地址执行

JMP	 0xF000:0xE05B

JMP	段地址:偏移地址

### 	033 硬盘构造和原理

Round Per Minute

盘片两面都有磁头,从第一个盘片的上面为磁头0,下面为磁头1,第二个盘片上面为磁头2,下面为磁头3

磁头绕一圈就是一个磁道

每个盘片的同一磁道形成一个竖着的圆柱,称为柱面,从边缘向圆心从0变大

为了加速,尽量不移动柱面,上一磁道写满向下一磁道写

将磁道看成一个圆被切开,每一块就是一个扇区,为512Bytes,通常63个扇区,从1开始编号

每个扇区间都有空隙

### 	034 从主引导扇区开始

ROM BIOS最后会将硬盘中的主引导扇区读到07C00处,然后跳转到那里执行

0盘面0磁道1扇区为主引导扇区

接力执行

### 	035~036 virtual Box安装.略

### 	037 虚拟硬盘(VHD)

### 	043 创建主引导扇区程序

​	主引导扇区为512Byte,最后两个字节必须是0x55,0xAA

```assembly
;...
times 502 db 0;重复502次定义单个空字节
db 0x55
db 0xAA
```

LBA逻辑地址块

![截屏2021-08-05 下午6.57.34](https://tva1.sinaimg.cn/large/008i3skNly1gt643qk4osj319g0u0gws.jpg)

### 045调试观察

RAX

![截屏2021-08-05 下午7.30.51](https://tva1.sinaimg.cn/large/008i3skNly1gt652d1t0fj319g0u0wgu.jpg)

```
bochs调试
b 0x7c00  在此处下端点
c  执行到断点停止
s	 执行下一条指令
xp /512xb 0x7c00 以十六进制的方式,以字节为单位显示512个单位个内存地址0x7c00的内容

```

`$`的意思是“这里的地址”。

`$$`的意思是“当前部分的开头地址”。

所以`$-$$`的意思是“当前大小的部分”。	

### 047 显卡&显存

通过更改显存中的数据,控制单个像素

显卡两种工作模式

​		文本模式,图像模式

显存被映射到内存空间中B000~BFFF,(32K)

一个文字需要两个字节,字符编码和显示属性

字符编码使用ASCII编码

显示属性如下![截屏2021-08-05 下午8.36.45](https://tva1.sinaimg.cn/large/008i3skNly1gt66ywvqblj319g0u0tbu.jpg)

![截屏2021-08-05 下午8.41.31](https://tva1.sinaimg.cn/large/008i3skNly1gt673w3u0tj319g0u0tce.jpg)

### 	051MOV指令的形式和机器码

MOV 目的,源

宽度必须相同

两个操作数不能同时是地址

段寄存器不能直接用立即数修改

不能修改IP寄存器

使用`nasm a.asm -l a.lst`生成列表文件,有**汇编地址**,汇编语句,机器码对应阅读

### 	053 使用标号

sign:

`times 510-(current-start) db 0`

### 	054 段间直接绝对跳转指令

​	jmp	段地址:偏移地址

​	注意:此操作会修改段寄存器

